---
import { Icon } from "astro-icon/components";

const { currentLocale } = Astro;
---

<!-- Chat Container -->
<div class="chat-container" id="chat-container">
  <!-- Chat Header -->
  <div class="mb-4 flex items-center">
    <div class="ml-3">
      <p class="text-xl font-medium">NickEsColR BOT</p>
      <span class="text-gray-500" id="status"
        >{currentLocale == "es" ? "Cargando" : "Loading"}</span
      >
    </div>
  </div>

  <!-- Chat Messages -->
  <ul class="message-container" id="message-container">
    <!-- Received Message -->
    <li class="message-bot">
      <p class="text-sm text-skin-base">Hello! How can I help you today?</p>
    </li>

    <!-- Sent Message -->
    <li class="message-user">
      <p class="text-sm text-skin-muted">Sure, I have a question.</p>
    </li>
  </ul>

  <!-- Chat Input -->
  <form class="mt-6 flex items-center" id="chat-form">
    <input
      id="chat-input"
      type="text"
      placeholder={currentLocale === "es"
        ? "Escribe un mensaje..."
        : "Type a message..."}
      class="flex-1 rounded-full bg-blue-100 px-3 py-2 focus:outline-none dark:bg-neutral-800"
    />
    <button
      id="chat-button"
      class="ml-3 cursor-pointer rounded-full bg-skin-button-accent px-4 py-2 hover:opacity-80"
      disabled
    >
      <Icon name="mdi:send" width={20} height={20} />
    </button>
  </form>
</div>

<template id="message-template">
  <li>
    <p class="text-sm"></p>
  </li>
</template>

<style>
  .chat-container {
    @apply flex flex-col rounded-lg border border-skin-muted bg-skin-fill p-4 shadow-md print:hidden;
    height: 50dvh;
  }

  .message-container {
    @apply flex w-full flex-1 flex-col space-y-4 overflow-y-auto;
    scrollbar-width: none;
  }

  .message-bot {
    @apply ml-3 w-fit items-start rounded-2xl rounded-tl-none bg-skin-hue p-3;
  }

  .message-user {
    @apply w-fit self-end rounded-2xl rounded-br-none bg-skin-muted p-3;
  }

  button[disabled] {
    @apply cursor-not-allowed bg-neutral-600;
  }
</style>

<script>
  import { isOpen } from "@/store/chat.store";

  isOpen.subscribe((open) => {
    const chat = document.querySelector("#chat-container") as HTMLDivElement;
    if (open) {
      chat.style.display = "flex";
    } else {
      chat.style.display = "none";
    }
  });
</script>

<script is:inline type="module">
  import { CreateWebWorkerMLCEngine } from "https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm@0.2.78/+esm";

  const button = document.querySelector("#chat-button");
  const loading = document.querySelector("#status");
  const form = document.querySelector("#chat-form");
  const input = document.querySelector("#chat-input");
  const template = document.querySelector("#message-template");
  const messagesContainer = document.querySelector("#message-container");

  let messages = [];
  let end = false;

  const SELECTED_MODEL = "Llama-3.2-1B-Instruct-q4f32_1-MLC";

  const engine = await CreateWebWorkerMLCEngine(
    new Worker("src/workers/chat.worker.js", { type: "module" }),
    SELECTED_MODEL,
    {
      initProgressCallback: (info) => {
        if (info.progress === 1 && !end) {
          end = true;
          loading.textContent = "Online";
          button.removeAttribute("disabled");
          addMessage(
            "¡Hola! Soy un ChatGPT que se ejecuta completamente en tu navegador. ¿En qué puedo ayudarte hoy?",
            "bot",
          );
        }
      },
    },
  );

  form.addEventListener("submit", async (event) => {
    event.preventDefault();
    const messageText = input.value.trim();

    if (messageText !== "") {
      input.value = "";
    }

    addMessage(messageText, "user");
    button.setAttribute("disabled", "");

    const userMessage = {
      role: "user",
      content: messageText,
    };

    messages.push(userMessage);

    const chunks = await engine.chat.completions.create({
      messages,
      stream: true,
    });

    let reply = "";

    const botMessage = addMessage("", "bot");

    for await (const chunk of chunks) {
      const choice = chunk.choices[0];
      const content = choice?.delta?.content ?? "";
      reply += content;
      botMessage.textContent = reply;
      scroll();
    }

    button.removeAttribute("disabled");
    messages.push({
      role: "assistant",
      content: reply,
    });
    scroll();
  });

  function scroll() {
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  function addMessage(text, sender) {
    const clonedTemplate = template.content.cloneNode(true);
    const newMessage = clonedTemplate.querySelector("li");
    const textContainer = newMessage.querySelector("p");

    textContainer.textContent = text;
    textContainer.classList.add(
      sender === "bot" ? "text-skin-base" : "text-skin-muted",
    );
    newMessage.classList.add(sender === "bot" ? "message-bot" : "message-user");

    messagesContainer.appendChild(newMessage);

    scroll();
    return textContainer;
  }
</script>
